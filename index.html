<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å‰ç«¯webå¤šçº¿ç¨‹åº”ç”¨å¼€å‘ | å‰ç«¯webå¤šçº¿ç¨‹åº”ç”¨å¼€å‘</title>
    <meta name="description" content="è¿…é›·äº‘å‰ç«¯åˆ†äº«-æå…´å¹¿.">
    <link rel="stylesheet" href="/webworker-app/assets/style.c62ae67b.css">
    <link rel="modulepreload" href="/webworker-app/assets/app.b663589b.js">
    <link rel="modulepreload" href="/webworker-app/assets/index.md.f57c00b5.lean.js">
    
    <meta name="twitter:title" content="å‰ç«¯webå¤šçº¿ç¨‹åº”ç”¨å¼€å‘ | å‰ç«¯webå¤šçº¿ç¨‹åº”ç”¨å¼€å‘">
  <meta property="og:title" content="å‰ç«¯webå¤šçº¿ç¨‹åº”ç”¨å¼€å‘ | å‰ç«¯webå¤šçº¿ç¨‹åº”ç”¨å¼€å‘">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-2ba227d5><div class="sidebar-button" data-v-2ba227d5><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/webworker-app/" aria-label="å‰ç«¯webå¤šçº¿ç¨‹åº”ç”¨å¼€å‘, back to home" data-v-2ba227d5 data-v-b3da5816><!----> å‰ç«¯webå¤šçº¿ç¨‹åº”ç”¨å¼€å‘</a><div class="flex-grow" data-v-2ba227d5></div><div class="nav" data-v-2ba227d5><!----></div><!--[--><!--]--></header><aside class="sidebar" data-v-79af364c><!----><!--[--><!--]--><ul class="sidebar-links" data-v-79af364c><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#å‰è¨€">å‰è¨€</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#ä¸€ã€æ˜ç¡®-javascript-æ˜¯å•çº¿ç¨‹">ä¸€ã€æ˜ç¡® JavaScript æ˜¯å•çº¿ç¨‹</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#äºŒã€æ–°æ›™å…‰ï¼šweb-worker">äºŒã€æ–°æ›™å…‰ï¼šWeb Worker</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#ä¸‰ã€åŸºæœ¬æµç¨‹">ä¸‰ã€åŸºæœ¬æµç¨‹</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-ä¸»çº¿ç¨‹">1. ä¸»çº¿ç¨‹</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-å­çº¿ç¨‹">2. å­çº¿ç¨‹</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#ä¸‰ã€åœºæ™¯å…·ç°">ä¸‰ã€åœºæ™¯å…·ç°</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-æ–‡ä»¶gcidè®¡ç®—">1. æ–‡ä»¶gcidè®¡ç®—</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-mpeg-ts-webplayer-æ’­æ”¾å™¨">2. mpeg-ts-webplayer æ’­æ”¾å™¨</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_3-webassembly-æ’­æ”¾å™¨">3. webassembly æ’­æ”¾å™¨</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-mqtté€šä¿¡">4. MQTTé€šä¿¡</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_5-btæ–‡ä»¶è§£æå™¨">5. BTæ–‡ä»¶è§£æå™¨</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_6-indexdbç¼“å­˜æ–¹å¼">6. IndexDbç¼“å­˜æ–¹å¼</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_7-lottieåŠ¨ç”»å®ç°">7. LottieåŠ¨ç”»å®ç°</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_8-pdfåœ¨çº¿é¢„è§ˆæ–¹æ¡ˆ">8. PDFåœ¨çº¿é¢„è§ˆæ–¹æ¡ˆ</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#å››ã€æ¶æ„ç­–ç•¥">å››ã€æ¶æ„ç­–ç•¥</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-å‡½æ•°å¼åˆ›å»ºå¹¶è¿è¡Œ-web-worker">1. å‡½æ•°å¼åˆ›å»ºå¹¶è¿è¡Œ web worker</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-vite-ts-worker-ä¸€ä¸ªå¿«é€Ÿæ„å»º-worker-æ¨¡å—çš„æ¨¡æ¿">2. vite-ts-worker ä¸€ä¸ªå¿«é€Ÿæ„å»º worker æ¨¡å—çš„æ¨¡æ¿</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_3-è°·æ­Œçš„-comlink">3. è°·æ­Œçš„ Comlink</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-partytown-æ‰§è¡Œç¬¬ä¸‰æ–¹è„šæœ¬æ–¹æ¡ˆ">4. Partytown æ‰§è¡Œç¬¬ä¸‰æ–¹è„šæœ¬æ–¹æ¡ˆ</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#æŠ€æœ¯å±•æœ›">æŠ€æœ¯å±•æœ›</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-30e7de44><div class="container" data-v-30e7de44><!--[--><!--]--><div style="position:relative;" class="content" data-v-30e7de44><div><h1 id="å‰ç«¯webå¤šçº¿ç¨‹åº”ç”¨å¼€å‘" tabindex="-1">å‰ç«¯webå¤šçº¿ç¨‹åº”ç”¨å¼€å‘ <a class="header-anchor" href="#å‰ç«¯webå¤šçº¿ç¨‹åº”ç”¨å¼€å‘" aria-hidden="true">#</a></h1><h2 id="å‰è¨€" tabindex="-1">å‰è¨€ <a class="header-anchor" href="#å‰è¨€" aria-hidden="true">#</a></h2><p>ä¸¤å¹´å‰æˆ‘æ›¾åœ¨å°ç»„å†…åˆ†äº«è¿‡ <a href="https://gitee.com/sternelee/example-worker" target="_blank" rel="noopener noreferrer">web workerå®è·µ</a>ï¼Œè€Œè¿™ä¸€å¹´å¤šåœ¨åšäº‘ç›˜ä¸šåŠ¡æ—¶æœ‰å¾ˆå¤šçš„åœºæ™¯éƒ½è¿ç”¨äº†è¿™ä¸€æŠ€æœ¯ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œç»§ç»­åˆ†äº«ä¸‹è¿™äº›æœ‰è¶£çš„å¼€å‘ç»éªŒã€‚</p><h2 id="ä¸€ã€æ˜ç¡®-javascript-æ˜¯å•çº¿ç¨‹" tabindex="-1">ä¸€ã€æ˜ç¡® <code>JavaScript</code> æ˜¯å•çº¿ç¨‹ <a class="header-anchor" href="#ä¸€ã€æ˜ç¡®-javascript-æ˜¯å•çº¿ç¨‹" aria-hidden="true">#</a></h2><blockquote><p>âœ… <code>JavaScript</code> è¯­è¨€çš„ä¸€å¤§ç‰¹ç‚¹å°±æ˜¯å•çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒä¸€ä¸ªæ—¶é—´åªèƒ½åšä¸€ä»¶äº‹ã€‚</p></blockquote><p>å¬èµ·æ¥æœ‰äº›åŒªå¤·æ‰€æ€ï¼Œä¸ºä»€ä¹ˆä¸è®¾è®¡æˆå¤šçº¿ç¨‹æé«˜æ•ˆç‡å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å‡è®¾ä¸€ç§åœºæ™¯ï¼š å‡å®š <code>JavaScript</code> åŒæ—¶æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨æŸä¸ª <code>DOM</code> èŠ‚ç‚¹ä¸Šæ·»åŠ å†…å®¹ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹åˆ é™¤äº†è¿™ä¸ªèŠ‚ç‚¹ï¼Œè¿™æ—¶æµè§ˆå™¨åº”è¯¥ä»¥å“ªä¸ªçº¿ç¨‹ä¸ºå‡†ï¼Ÿ</p><blockquote><p>âœ… ä½œä¸ºæµè§ˆå™¨è„šæœ¬è¯­è¨€ï¼Œ<code>JavaScript</code> çš„ä¸»è¦ç”¨é€”æ˜¯ä¸ç”¨æˆ·äº’åŠ¨ï¼Œä»¥åŠæ“ä½œ DOMã€‚</p></blockquote><p>è¿™å†³å®šäº†å®ƒåªèƒ½æ˜¯å•çº¿ç¨‹ï¼Œå¦åˆ™ä¼šå¸¦æ¥å¾ˆå¤æ‚çš„åŒæ­¥é—®é¢˜ã€‚ä¸ºäº†é¿å…å¤æ‚æ€§ï¼Œä»ä¸€è¯ç”Ÿï¼Œ<code>JavaScript</code> å°±æ˜¯å•çº¿ç¨‹ï¼Œè¿™å·²ç»æˆäº†è¿™é—¨è¯­è¨€çš„æ ¸å¿ƒç‰¹å¾ï¼Œä¼°è®¡çŸ­æœŸå†…å¾ˆéš¾æ”¹å˜ã€‚</p><h2 id="äºŒã€æ–°æ›™å…‰ï¼šweb-worker" tabindex="-1">äºŒã€æ–°æ›™å…‰ï¼šWeb Worker <a class="header-anchor" href="#äºŒã€æ–°æ›™å…‰ï¼šweb-worker" aria-hidden="true">#</a></h2><p>å•çº¿ç¨‹å§‹ç»ˆæ˜¯ä¸€ä¸ªç—›ç‚¹ï¼Œä¸ºäº†åˆ©ç”¨å¤šæ ¸ <strong>CPU</strong> çš„è®¡ç®—èƒ½åŠ›ï¼Œ<code>HTML5</code> æå‡º Web Worker æ ‡å‡†ï¼Œå…è®¸ <code>JavaScript</code> è„šæœ¬åˆ›å»ºå¤šä¸ªçº¿ç¨‹ã€‚ä½†æ˜¯å­çº¿ç¨‹å®Œå…¨å—ä¸»çº¿ç¨‹æ§åˆ¶ï¼Œä¸”ä¸å¾—æ“ä½œ <code>DOM</code>ã€‚</p><blockquote><p>ğŸ’» æ‰€ä»¥ï¼Œè¿™ä¸ªæ–°æ ‡å‡†å¹¶æ²¡æœ‰æ”¹å˜ <code>JavaScript</code> å•çº¿ç¨‹çš„æœ¬è´¨ã€‚</p></blockquote><p><code>Web Workers</code> æ˜¯ç°ä»£æµè§ˆå™¨æä¾›çš„ä¸€ä¸ª <code>JavaScript</code> å¤šçº¿ç¨‹è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¾ˆå¤šä½¿ç”¨åœºæ™¯ï¼š</p><ol><li>æˆ‘ä»¬å¯ä»¥ç”¨ <code>Web Worker</code> åšä¸€äº›å¤§è®¡ç®—é‡çš„æ“ä½œï¼›</li><li>å¯ä»¥å®ç°è½®è¯¢ï¼Œæ”¹å˜æŸäº›çŠ¶æ€ï¼›</li><li>é¡µå¤´æ¶ˆæ¯çŠ¶æ€æ›´æ–°ï¼Œæ¯”å¦‚é¡µå¤´çš„æ¶ˆæ¯ä¸ªæ•°é€šçŸ¥ï¼›</li><li>é«˜é¢‘ç”¨æˆ·äº¤äº’ï¼Œæ‹¼å†™æ£€æŸ¥ï¼Œè­¬å¦‚ï¼šæ ¹æ®ç”¨æˆ·çš„è¾“å…¥ä¹ æƒ¯ã€å†å²è®°å½•ä»¥åŠç¼“å­˜ç­‰ä¿¡æ¯æ¥ååŠ©ç”¨æˆ·å®Œæˆè¾“å…¥çš„çº é”™ã€æ ¡æ­£åŠŸèƒ½ç­‰</li><li>åŠ å¯†ï¼šåŠ å¯†æœ‰æ—¶å€™ä¼šéå¸¸åœ°è€—æ—¶ï¼Œç‰¹åˆ«æ˜¯å¦‚æœå½“ä½ éœ€è¦ç»å¸¸åŠ å¯†å¾ˆå¤šæ•°æ®çš„æ—¶å€™ï¼ˆæ¯”å¦‚ï¼Œå‘å¾€æœåŠ¡å™¨å‰åŠ å¯†æ•°æ®ï¼‰ã€‚</li><li>é¢„å–æ•°æ®ï¼šä¸ºäº†ä¼˜åŒ–ç½‘ç«™æˆ–è€…ç½‘ç»œåº”ç”¨åŠæå‡æ•°æ®åŠ è½½æ—¶é—´ï¼Œä½ å¯ä»¥ä½¿ç”¨ <strong>Workers</strong> æ¥æå‰åŠ è½½éƒ¨åˆ†æ•°æ®ä»¥å¤‡ä¸æ—¶ä¹‹éœ€ã€‚</li></ol><blockquote><p>ğŸ’» é€šè¿‡ä½¿ç”¨<code>Web Workers</code>ï¼ŒWebåº”ç”¨ç¨‹åºå¯ä»¥åœ¨ç‹¬ç«‹äºä¸»çº¿ç¨‹çš„åå°çº¿ç¨‹ä¸­ï¼Œè¿è¡Œä¸€ä¸ªè„šæœ¬æ“ä½œã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­æ‰§è¡Œè´¹æ—¶çš„å¤„ç†ä»»åŠ¡ï¼Œä»è€Œå…è®¸ä¸»çº¿ç¨‹ï¼ˆé€šå¸¸æ˜¯<strong>UI</strong>çº¿ç¨‹ï¼‰ä¸ä¼šå› æ­¤è¢«é˜»å¡/æ”¾æ…¢ã€‚</p></blockquote><p>åŠ å¯†æ˜¯ä¸€ä¸ªä½¿ç”¨ <code>Web Worker</code> çš„ç»ä½³åœºæ™¯ï¼Œå› ä¸ºå®ƒå¹¶ä¸éœ€è¦è®¿é—® DOM æˆ–è€…åˆ©ç”¨å…¶å®ƒé­”æ³•ï¼Œå®ƒåªæ˜¯çº¯ç²¹ä½¿ç”¨ç®—æ³•è¿›è¡Œè®¡ç®—è€Œå·²ã€‚</p><blockquote><p>ğŸ”¥ ä¸€æ—¦åœ¨ <code>Worker</code> è¿›è¡Œè®¡ç®—ï¼Œå®ƒå¯¹äºç”¨æˆ·æ¥è¯´æ˜¯æ— ç¼åœ°ä¸”ä¸ä¼šå½±å“åˆ°ç”¨æˆ·ä½“éªŒã€‚</p></blockquote><h2 id="ä¸‰ã€åŸºæœ¬æµç¨‹" tabindex="-1">ä¸‰ã€åŸºæœ¬æµç¨‹ <a class="header-anchor" href="#ä¸‰ã€åŸºæœ¬æµç¨‹" aria-hidden="true">#</a></h2><h3 id="_1-ä¸»çº¿ç¨‹" tabindex="-1">1. ä¸»çº¿ç¨‹ <a class="header-anchor" href="#_1-ä¸»çº¿ç¨‹" aria-hidden="true">#</a></h3><p><img src="/webworker-app/assets/webworker-main.75914da5.png" alt=""></p><h3 id="_2-å­çº¿ç¨‹" tabindex="-1">2. å­çº¿ç¨‹ <a class="header-anchor" href="#_2-å­çº¿ç¨‹" aria-hidden="true">#</a></h3><p><img src="/webworker-app/assets/webworker-worker.26dc64b7.png" alt=""></p><h2 id="ä¸‰ã€åœºæ™¯å…·ç°" tabindex="-1">ä¸‰ã€åœºæ™¯å…·ç° <a class="header-anchor" href="#ä¸‰ã€åœºæ™¯å…·ç°" aria-hidden="true">#</a></h2><h3 id="_1-æ–‡ä»¶gcidè®¡ç®—" tabindex="-1">1. æ–‡ä»¶gcidè®¡ç®— <a class="header-anchor" href="#_1-æ–‡ä»¶gcidè®¡ç®—" aria-hidden="true">#</a></h3><blockquote><p>åœ¨åšwebç«¯äº‘ç›˜å¤§æ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­è¯¥æ–‡ä»¶æ˜¯å¦æ”¯æŒä¼ ï¼ˆæœåŠ¡å­˜æœ‰ç›¸åŒçš„æ–‡ä»¶ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ–‡ä»¶è®¡ç®—<code>gcid</code>å€¼, ä½†crypto.jsè®¡ç®—æ–‡ä»¶sha1å€¼ä¼šå¡çº¿ç¨‹ï¼Œé˜»å¡ç”¨æˆ·äº¤äº’,å¹¶ä¸”æ˜¯ä¸ªè€—æ—¶çš„è¿‡ç¨‹</p></blockquote><p>åœ¨æ­¤åˆ›å»ºäº† <a href="https://gitlab.xunlei.cn/xl9_web/gcid-worker" target="_blank" rel="noopener noreferrer">gcid-worker</a> æ¨¡å—ï¼Œç”¨äºåœ¨ <code>web worker</code> å­çº¿ç¨‹ç¯å¢ƒä¸‹åˆ†ç‰‡è®¡ç®— <code>SHA1</code> å€¼å¹¶æœ€ç»ˆç”Ÿæˆå”¯ä¸€å­—ç¬¦ä¸²</p><div class="language-typescript"><pre><code><span class="token keyword">import</span> GcidWorker <span class="token keyword">from</span> <span class="token string">&#39;@xunlei/gcid-worker&#39;</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GcidWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;file&#39;</span><span class="token punctuation">)</span>

file<span class="token operator">?.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;change&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> blockSize <span class="token operator">=</span> worker<span class="token punctuation">.</span><span class="token function">getChunkSize</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token constant">CHUNK_MIN_SIZE</span> <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>
  <span class="token keyword">const</span> <span class="token constant">CHUNK_SIZE</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token constant">CHUNK_MIN_SIZE</span> <span class="token operator">/</span> blockSize<span class="token punctuation">)</span> <span class="token operator">*</span> blockSize
  <span class="token keyword">const</span> <span class="token constant">CHUNK_LEN</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token constant">CHUNK_SIZE</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> reverseIndex <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">await</span> worker<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> worker<span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span>result <span class="token keyword">as</span> ArrayBuffer<span class="token punctuation">)</span>
    reverseIndex <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reverseIndex <span class="token operator">&gt;=</span> <span class="token constant">CHUNK_LEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> worker<span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">seek</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">seek</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">seek</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token constant">CHUNK_SIZE</span> <span class="token operator">*</span> reverseIndex
    <span class="token keyword">const</span> end <span class="token operator">=</span> <span class="token punctuation">(</span>reverseIndex <span class="token operator">&gt;=</span> <span class="token constant">CHUNK_LEN</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> file<span class="token punctuation">.</span>size <span class="token operator">:</span> <span class="token constant">CHUNK_SIZE</span> <span class="token operator">*</span> <span class="token punctuation">(</span>reverseIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> slice <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
    reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>slice<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_2-mpeg-ts-webplayer-æ’­æ”¾å™¨" tabindex="-1">2. <code>mpeg-ts-webplayer</code> æ’­æ”¾å™¨ <a class="header-anchor" href="#_2-mpeg-ts-webplayer-æ’­æ”¾å™¨" aria-hidden="true">#</a></h3><blockquote><p>åœ¨åšwebäº‘ç›˜çš„æ–‡ä»¶æ¶ˆè´¹æ—¶ï¼Œè§†é¢‘åœ¨çº¿æ’­æ”¾æ˜¯å æœ€å¤§æ¯”é‡çš„ä½¿ç”¨åœºæ™¯; è€Œç›®å‰è¿…é›·äº‘ç›˜å­˜æ”¾çš„è½¬ç è§†é¢‘ä¸º <code>h265</code> çš„ <code>mpeg-ts</code> æ ¼å¼ï¼Œæµè§ˆå™¨åŸç”Ÿä¸æ”¯æŒ</p></blockquote><p>åœ¨éœ€æ±‚è¯„ä¼°ä¸‹ï¼Œæˆ‘æ¢ç´¢äº†ä¸€äº›å¼€æºçš„<code>mpeg-ts</code>æ’­æ”¾å™¨æ–¹æ¡ˆ,å¹¶ç»“åˆç°ä¸‹çš„äº‘ç›˜åœºæ™¯ï¼Œå¼€å‘äº†ä¸€å¥— <code>M3U8</code> æ’­æ”¾å™¨æ–¹æ¡ˆ: <a href="https://gitlab.xunlei.cn/xl9_web/mpeg-ts-webplayer/tree/develop" target="_blank" rel="noopener noreferrer">mpeg-ts-webplayer</a></p><p>åœ¨ä¸‰å¤§åŠŸèƒ½åœºæ™¯ä¸‹é‡‡ç”¨ <code>web worker</code> æŠ€æœ¯</p><ol><li>HTTP è¯·æ±‚å°è£…å™¨ <a href="https://gitlab.xunlei.cn/xl9_web/mpeg-ts-webplayer/blob/develop/src/workers/httpWorker.ts" target="_blank" rel="noopener noreferrer">httpWorker.ts</a>: åœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸‹å¤„ç†åˆ†ç‰‡æ•°æ®è¯·æ±‚,æ§åˆ¶ç¼“å­˜æ•°æ®é‡</li><li>Demux è§£å¤ç”¨å™¨ <a href="https://gitlab.xunlei.cn/xl9_web/mpeg-ts-webplayer/blob/develop/src/workers/demuxWorker.ts" target="_blank" rel="noopener noreferrer">demuxWorker.ts</a>: åœ¨ <code>web worker</code> çº¿ç¨‹ä¸‹å¤„ç† <code>mpeg-ts</code> æ•°æ®æµï¼Œå°†å…¶è§£å°è£…ç”ŸæˆéŸ³é¢‘æµå’Œè§†é¢‘æµ(<code>h265</code>æºæ•°æ®)</li><li>Decode è§†é¢‘è§£æ <a href="https://gitlab.xunlei.cn/xl9_web/mpeg-ts-webplayer/blob/develop/src/workers/decodeWorker.ts" target="_blank" rel="noopener noreferrer">decodeWorker.ts</a>: åˆ©ç”¨ <code>ffmpeg</code> å·¥å…·ç”Ÿæˆ <code>webassembly</code> è§£ç å™¨ï¼Œå°† <code>h265</code> è§†é¢‘è§£ç æˆ <code>YUV</code> è§†é¢‘ç”»é¢, å¹¶æœ€ç»ˆå›ä¼ ç»™ä¸»çº¿ç¨‹ï¼Œé‡‡ç”¨ <code>yuv-canvas</code> è¿›ç»˜åˆ¶æ’­æ”¾</li></ol><p>è¯¥æ–¹æ¡ˆé…åˆè¿…é›·äº‘ç›˜è½¬ç çš„æ–¹æ¡ˆï¼Œä½¿ç”¨æœ‰åºçš„ <code>m3u8</code> æ•°æ®è¡¨æ¥è¿›è¡Œè¿æƒ¯çš„åœ¨çº¿ mpeg-tsï¼ˆh265)æ’­æ”¾ï¼Œåœ¨è¿™é‡Œæœ‰æ•ˆçš„åˆ©ç”¨ <code>web worker</code> çš„ç‰¹æ®Šçš„åœºæ™¯èƒ½åŠ›æ¥è¯·æ±‚ç½‘ç»œè¯·æ±‚ã€webassemblyåŠ è½½è§£æã€å¤æ‚ç¹é‡è®¡ç®—ç­‰ä¸æ›¿ä»£çš„åŠŸèƒ½</p><video controls="" preload style="width:100%;"><source src="http://static.leeapps.cn/webworker-mpeg-player.mp4" type="video/mp4"></video><h3 id="_3-webassembly-æ’­æ”¾å™¨" tabindex="-1">3. <code>webassembly</code> æ’­æ”¾å™¨ <a class="header-anchor" href="#_3-webassembly-æ’­æ”¾å™¨" aria-hidden="true">#</a></h3><blockquote><p>åœ¨é€‚é…å°ç±³æ‰‹æœºæµè§ˆå™¨é›†æˆè¿…é›·äº‘ç›˜ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åœ¨H5ç«¯å®ç°å‡ ä¹æ‰€æœ‰æ ¼å¼çš„è§†é¢‘æ’­æ”¾, ç›¸å½“äºè¦åœ¨æµè§ˆå™¨ç«¯å®ç° Web ç‰ˆè¿…é›·æ’­æ”¾å™¨</p></blockquote><p><a href="https://gitlab.xunlei.cn/xl9_web/h5player-pan.xunlei.com" target="_blank" rel="noopener noreferrer">h5player-pan.xunlei.com</a> é¡¹ç›®åŒæ—¶æ”¯æŒ åŸç”Ÿè§†é¢‘videoæ ‡ç­¾ã€å°ç±³æµè§ˆå™¨ m3u8 å’Œ <code>webassembly</code> æ’­æ”¾æ¨¡å¼, ä½“éªŒ <code>webassembly</code> é«˜æ€§èƒ½æ’­æ”¾åœ¨è®¿é—® <a href="https://pan.xunlei.com/xapp/play/" target="_blank" rel="noopener noreferrer">https://pan.xunlei.com/xapp/play/</a> , åªéœ€è®¾ç½® <code>?playType=1</code> å¹¶æä¾›å¯è®¿é—®çš„ <code>https</code> çš„èµ„æºé“¾æ¥å³å¯æ’­æ”¾</p><video controls="" preload style="width:100%;"><source src="http://static.leeapps.cn/webworker-aplayer.mp4" type="video/mp4"></video><p>ğŸŒŸ Tip: è¯¥æ–¹æ¡ˆé‡‡ç”¨ <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/SharedWorker" target="_blank" rel="noopener noreferrer"><code>Shared Worker</code></a> éœ€è¦æ³¨æ„å‡ ç‚¹</p><ol><li>è¿™äº›é¡µé¢å’Œèµ„æºè¯·æ±‚å¿…é¡»æ˜¯åŒæºçš„</li><li>é¡µé¢é€šè¿‡é…ç½® nginx é…ç½®åŒæºç­–ç•¥ï¼Œå¦‚ä¸‹æ˜¾ç¤º</li></ol><div class="language-yml"><pre><code>add_header Cross<span class="token punctuation">-</span>Origin<span class="token punctuation">-</span>Opener<span class="token punctuation">-</span>Policy &#39;same<span class="token punctuation">-</span>origin&#39;;
add_header Cross<span class="token punctuation">-</span>Origin<span class="token punctuation">-</span>Embedder<span class="token punctuation">-</span>Policy &#39;require<span class="token punctuation">-</span>corp&#39;;
</code></pre></div><ol start="3"><li>æ³¨æ„å†…å­˜å›æ”¶å’Œæµè§ˆå™¨å…¼å®¹æ€§</li></ol><h3 id="_4-mqtté€šä¿¡" tabindex="-1">4. MQTTé€šä¿¡ <a class="header-anchor" href="#_4-mqtté€šä¿¡" aria-hidden="true">#</a></h3><blockquote><p>åœ¨å¼€å‘NASäº‘ç›˜H5æ—¶ï¼Œä»»åŠ¡çš„æ›´æ–°éƒ½ä¾èµ–å®šæ—¶æ›´æ–°ä»»åŠ¡æ¥å£ï¼Œåœ¨å¤šç«¯æ“ä½œæ—¶ä¼šå“åº”ä¸åŠæ—¶çš„æƒ…å†µ</p></blockquote><p>åœ¨æ­¤åœºæ™¯ä¸‹ï¼Œç»“åˆå¸å·ç°æœ‰çš„<code>xbase mqtt</code>æµç¨‹ï¼Œåˆ›å»ºäº† <a href="https://gitlab.xunlei.cn/xl_public_service/mqtt-worker" target="_blank" rel="noopener noreferrer"><code>mqtt-worker</code></a> æ¨¡å—ï¼Œä¸ <code>xbase</code> å¸å·è§£è€¦ï¼Œå¹¶é‡‡ç”¨ <code>worker</code> çº¿ç¨‹æ¥å¤„ç†æ¶ˆæ¯ã€‚</p><div class="language-typescript"><pre><code><span class="token keyword">import</span> SyncClient <span class="token keyword">from</span> <span class="token string">&#39;@xunlei/mqtt-worker&#39;</span>

<span class="token keyword">const</span> projectID <span class="token operator">=</span> <span class="token string">&#39;2rvk4e3gkdnl7u1kl0k&#39;</span> <span class="token comment">//å‚è€ƒï¼šhttps://xbase.cloud/docs/%E5%AE%9E%E6%97%B6%E9%80%9A%E4%BF%A1%E5%BC%95%E6%93%8E/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8</span>
<span class="token comment">// ç™»é™†æ€</span>
<span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string-property property">&quot;token_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;Bearer&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;access_token&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;refresh_token&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;expires_in&quot;</span><span class="token operator">:</span><span class="token number">3600</span><span class="token punctuation">,</span><span class="token string-property property">&quot;sub&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;user_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;expires_at&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> user_id <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
<span class="token keyword">const</span> deviceID <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
<span class="token keyword">const</span> syncClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  projectID<span class="token punctuation">,</span>
  token<span class="token punctuation">,</span>
  user_id<span class="token punctuation">,</span>
  deviceID<span class="token punctuation">,</span>
  <span class="token comment">// client_version: &#39;1.0.0&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// ç›‘å¬äº‘ç›˜æ–‡ä»¶å˜æ›´çš„ä¸»é¢˜</span>
<span class="token keyword">const</span> subject <span class="token operator">=</span> <span class="token string">&#39;/user/me/drive/tasks&#39;</span> <span class="token comment">//  ç”¨æˆ·ä¿¡æ¯å˜æ›´&#39;/user/me/info&#39;</span>
syncClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connect&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç›‘å¬è¿æ¥æˆåŠŸ</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;result connect&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
  <span class="token comment">// å‘é€ç›‘å¬ä¸»é¢˜</span>
  syncClient<span class="token punctuation">.</span><span class="token function">startReceiver</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
syncClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;topic&#39;</span><span class="token punctuation">,</span> data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;topics&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
syncClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ¥æ”¶ä¸»é¢˜äº‹ä»¶</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
syncClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;å…¶ä»–æ¶ˆæ¯&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// è¿æ¥</span>
syncClient<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// å‘é€æ¶ˆæ¯</span>
syncClient<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> subject<span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// å…³é—­</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> syncClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">6000</span><span class="token punctuation">)</span>
</code></pre></div><p>æ³¨æ„ï¼š<code>MQTT</code>æ–¹æ¡ˆéœ€è¦è€ƒè™‘å¤šæ ‡ç­¾æƒ…å†µä¸‹ç™»é™†æ€äº’è¸¢çš„æƒ…å†µ</p><h3 id="_5-btæ–‡ä»¶è§£æå™¨" tabindex="-1">5. BTæ–‡ä»¶è§£æå™¨ <a class="header-anchor" href="#_5-btæ–‡ä»¶è§£æå™¨" aria-hidden="true">#</a></h3><p><a href="https://gitlab.xunlei.cn/xl9_web/bencode-worker" target="_blank" rel="noopener noreferrer">bencode-worker</a> ä½¿ç”¨ <code>bencode</code> + <code>web worker</code> å°†btæ–‡ä»¶è½¬æˆç£åŠ›é“¾æ¥ï¼›è¿™æ˜¯ <a href="https://pan.xunlei.com/yc/" target="_blank" rel="noopener noreferrer">NASäº‘ç›˜H5</a>ä½¿ç”¨çš„æ–¹æ¡ˆ</p><div class="language-typescript"><pre><code><span class="token keyword">import</span> btdecode <span class="token keyword">from</span> <span class="token string">&#39;@xunlei/bencode-worker&#39;</span>

<span class="token keyword">const</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;file&#39;</span><span class="token punctuation">)</span>
file<span class="token operator">?.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;change&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>evt<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> file <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">btdecode</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_6-indexdbç¼“å­˜æ–¹å¼" tabindex="-1">6. IndexDbç¼“å­˜æ–¹å¼ <a class="header-anchor" href="#_6-indexdbç¼“å­˜æ–¹å¼" aria-hidden="true">#</a></h3><blockquote><p>ğŸŒˆ ä½ ä¸èƒ½ç›´æ¥åœ¨ worker çº¿ç¨‹ä¸­æ“çºµ DOM å…ƒç´ ï¼›æˆ–ä½¿ç”¨window å¯¹è±¡ä¸­çš„æŸäº›æ–¹æ³•å’Œå±æ€§ã€‚å¤§éƒ¨åˆ† window å¯¹è±¡çš„æ–¹æ³•å’Œå±æ€§æ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼ŒåŒ…æ‹¬ WebSockets å’Œ IndexedDBã€‚ - æ‘˜è‡ª <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API" target="_blank" rel="noopener noreferrer">Web_Workers_API</a></p></blockquote><p><a href="https://gitee.com/sternelee/vite-translator-worker" target="_blank" rel="noopener noreferrer">translator-worker</a> å‰ç«¯å®ç°é¡µé¢ç¿»è¯‘, è¿™æ˜¯æˆ‘ä» <a href="https://github.com/FilipePS/Traduzir-paginas-web" target="_blank" rel="noopener noreferrer">Traduzir-paginas-web</a> æ’ä»¶æå–è€Œæ¥, å¹¶æ›´æ”¹ä¸º <code>worker</code> çº¿ç¨‹ç‰ˆæœ¬ï¼Œä½¿ç”¨ä¹Ÿæå…¶æ–¹ä¾¿</p><div class="language-typescript"><pre><code><span class="token keyword">import</span> translator <span class="token keyword">from</span> <span class="token string">&#39;@sternelee/translator-worker&#39;</span>

window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç¿»è¯‘å…¨æ–‡</span>
  translator<span class="token punctuation">.</span><span class="token function">translatePage</span><span class="token punctuation">(</span><span class="token string">&quot;zh&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ç¿»è¯‘æ–‡æœ¬</span>
  <span class="token keyword">const</span> txt <span class="token operator">=</span> <span class="token keyword">await</span> translator<span class="token punctuation">.</span><span class="token function">translateText</span><span class="token punctuation">(</span><span class="token string">&quot;google&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;zh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;I Love Code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// æ¢å¤</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    translator<span class="token punctuation">.</span><span class="token function">restorePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡Œæœ‰å®é™…ä½¿ç”¨çš„çº¿ä¸Šé¡µé¢ <a href="https://weekly.leeapps.cn/" target="_blank" rel="noopener noreferrer">https://weekly.leeapps.cn/</a></p><video controls="" preload style="width:100%;"><source src="http://static.leeapps.cn/webworker-indexdb.mp4" type="video/mp4"></video><h3 id="_7-lottieåŠ¨ç”»å®ç°" tabindex="-1">7. LottieåŠ¨ç”»å®ç° <a class="header-anchor" href="#_7-lottieåŠ¨ç”»å®ç°" aria-hidden="true">#</a></h3><p><a href="https://gitee.com/sternelee/rlottie-worker" target="_blank" rel="noopener noreferrer">rlottie-worker</a> è¿™æ˜¯æˆ‘ä½¿ç”¨ <code>rlottie</code> + <code>pako</code> + <code>webworker</code> åœ¨å‰ç«¯å®ç° <code>lottie</code> çš„åŠ¨ç”»æ•ˆæœ, æ˜¯ä»<code>telegram</code> å®˜ç½‘åŠ¨ç”»çš„æ•ˆæœæå–å‡ºæ¥çš„</p><p>ä½¿ç”¨ä¹Ÿéå¸¸æ–¹ä¾¿</p><div class="language-typescript"><pre><code><span class="token keyword">import</span> RLottie <span class="token keyword">from</span> <span class="token string">&#39;@sternelee/rlottie&#39;</span>

document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">&#39;.rlottie_image&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>imgEl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  RLottie<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>imgEl<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string-property property">&quot;maxDeviceRatio&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string-property property">&quot;cachingModulo&quot;</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><iframe style="width:100%;" frameborder="0" scrolling="0" height="600px" src="http://leeapps.cn:4002/">
</iframe><h3 id="_8-pdfåœ¨çº¿é¢„è§ˆæ–¹æ¡ˆ" tabindex="-1">8. PDFåœ¨çº¿é¢„è§ˆæ–¹æ¡ˆ <a class="header-anchor" href="#_8-pdfåœ¨çº¿é¢„è§ˆæ–¹æ¡ˆ" aria-hidden="true">#</a></h3><p>å½“å‰webäº‘ç›˜çš„pdfåœ¨çº¿é¢„è§ˆé‡‡ç”¨äº† <a href="https://mozilla.github.io/pdf.js/" target="_blank" rel="noopener noreferrer">PDF.js</a>, åŒæ ·ä¾èµ– <code>web worker</code> æ¥å®ç°pdfæ–‡ä»¶çš„è§£æ</p><h2 id="å››ã€æ¶æ„ç­–ç•¥" tabindex="-1">å››ã€æ¶æ„ç­–ç•¥ <a class="header-anchor" href="#å››ã€æ¶æ„ç­–ç•¥" aria-hidden="true">#</a></h2><p>åˆ›å»º <code>web worker</code> çš„æ–¹å¼å¾ˆå¤š, å¦‚å¤–è”å¼•å…¥js, <code>Blob</code> å†…è”, å¹¶é‡‡ç”¨<code>promise</code>æ¨¡å¼</p><h3 id="_1-å‡½æ•°å¼åˆ›å»ºå¹¶è¿è¡Œ-web-worker" tabindex="-1">1. å‡½æ•°å¼åˆ›å»ºå¹¶è¿è¡Œ <code>web worker</code> <a class="header-anchor" href="#_1-å‡½æ•°å¼åˆ›å»ºå¹¶è¿è¡Œ-web-worker" aria-hidden="true">#</a></h3><p><a href="https://gitlab.xunlei.cn/xl9_web/universal-native-api/blob/master/src/lib/utils.ts#L281" target="_blank" rel="noopener noreferrer">promiseWorkerFun</a> è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„æ–¹æ³•,å¹¶é›†æˆåˆ° <code>universal-native-api</code> ä¸­</p><div class="language-typescript"><pre><code><span class="token comment">/**
 * @description åœ¨å†…è”web workerä¸­è¿è¡Œå‡½æ•°
 * @param {Function} func - å‡½æ•°
 * @param {any[]} message - å‡½æ•°å‚æ•°
 * @returns {Promise} - è¿”å›Promiseå¯¹è±¡æ‰§è¡Œç»“æœ
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">promiseWorkerFun</span><span class="token punctuation">(</span>func<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> <span class="token operator">...</span>message<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">delegate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token punctuation">{</span> func<span class="token punctuation">,</span> message <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">wrapper</span> <span class="token operator">=</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token function">Function</span><span class="token punctuation">(</span><span class="token string">&#39;&quot;use strict&quot;; return (&#39;</span> <span class="token operator">+</span> fn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;)&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">...</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">postMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> functionBody <span class="token operator">=</span> delegate
    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[^{]*{\s*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s*}[^}]*$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>
      <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>functionBody<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;text/javascript&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      worker<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span>onerror <span class="token operator">=</span> worker<span class="token punctuation">.</span>onmessageerror <span class="token operator">=</span> reject<span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> func<span class="token operator">:</span> func<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> worker<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-vite-ts-worker-ä¸€ä¸ªå¿«é€Ÿæ„å»º-worker-æ¨¡å—çš„æ¨¡æ¿" tabindex="-1">2. <a href="https://gitlab.xunlei.cn/xl9_web/fe-template/tree/vite-ts-worker" target="_blank" rel="noopener noreferrer">vite-ts-worker</a> ä¸€ä¸ªå¿«é€Ÿæ„å»º <code>worker</code> æ¨¡å—çš„æ¨¡æ¿ <a class="header-anchor" href="#_2-vite-ts-worker-ä¸€ä¸ªå¿«é€Ÿæ„å»º-worker-æ¨¡å—çš„æ¨¡æ¿" aria-hidden="true">#</a></h3><p>ä½¿ç”¨ <code>vite</code> æ¥æ‰“åŒ… <code>web worker</code> åŠŸèƒ½åº“ æ ¹æ®éœ€æ±‚é…ç½® <code>vite.config.ts</code> æ‰“åŒ…ç”Ÿæˆçš„æ–‡ä»¶</p><p>ä¸Šé¢ä»‹ç»åˆ°çš„ <code>gcid-worker</code>, <code>bencode-worker</code>, ä»¥åŠ <code>translator-worker</code> éƒ½æ˜¯é‡‡ç”¨è¯¥æ¨¡æ¿æ‰“åŒ…</p><p><a href="https://cn.vitejs.dev/guide/assets.html#importing-script-as-a-worker" target="_blank" rel="noopener noreferrer">vite æ‰“åŒ…</a> åŸç”Ÿæ”¯æŒäº†å¯¼å…¥è„šæœ¬ä½œä¸º Worker çš„åŠŸèƒ½,å¹¶åšå†…è”æ¨¡å—æˆ–å­—ç¬¦ä¸²å½¢å¼</p><h3 id="_3-è°·æ­Œçš„-comlink" tabindex="-1">3. è°·æ­Œçš„ <a href="https://github.com/GoogleChromeLabs/comlink" target="_blank" rel="noopener noreferrer"><code>Comlink</code></a> <a class="header-anchor" href="#_3-è°·æ­Œçš„-comlink" aria-hidden="true">#</a></h3><blockquote><p>è®©ä½¿ç”¨webworkerè¶…è½»æ¾ï¼Œè¿™æ˜¯ <code>Comlink</code> çš„å®ç°æ–¹å‘</p></blockquote><p><img src="/webworker-app/assets/comlink.8a7c8a30.png" alt=""></p><p><code>Comlink</code> é‡‡ç”¨äº† <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Channel_Messaging_API" target="_blank" rel="noopener noreferrer">Channel Messaging API</a>ã€‚ å…·ä½“è§£æ -&gt; <a href="https://juejin.cn/post/6968503345031938085" target="_blank" rel="noopener noreferrer">Comlink çš„ä½¿ç”¨ &amp; æºç è§£æ</a></p><blockquote><p>Channel Messaging API å…è®¸ä¸¤ä¸ªä¸åŒçš„è„šæœ¬è¿è¡Œåœ¨åŒä¸€ä¸ªæ–‡æ¡£çš„ä¸åŒæµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼ˆæ¯”å¦‚ä¸¤ä¸ª iframeï¼Œæˆ–è€…æ–‡æ¡£ä¸»ä½“å’Œä¸€ä¸ª iframeï¼Œä½¿ç”¨ SharedWorker çš„ä¸¤ä¸ªæ–‡æ¡£ï¼Œæˆ–è€…ä¸¤ä¸ª workerï¼‰æ¥ç›´æ¥é€šè®¯ï¼Œåœ¨æ¯ç«¯ä½¿ç”¨ä¸€ä¸ªç«¯å£ï¼ˆportï¼‰é€šè¿‡åŒå‘é¢‘é“ï¼ˆchannelï¼‰å‘å½¼æ­¤ä¼ é€’æ¶ˆæ¯ã€‚</p></blockquote><h3 id="_4-partytown-æ‰§è¡Œç¬¬ä¸‰æ–¹è„šæœ¬æ–¹æ¡ˆ" tabindex="-1">4. <a href="https://partytown.builder.io/" target="_blank" rel="noopener noreferrer"><code>Partytown</code></a> æ‰§è¡Œç¬¬ä¸‰æ–¹è„šæœ¬æ–¹æ¡ˆ <a class="header-anchor" href="#_4-partytown-æ‰§è¡Œç¬¬ä¸‰æ–¹è„šæœ¬æ–¹æ¡ˆ" aria-hidden="true">#</a></h3><p>è¿™æ˜¯æœ€è¿‘ <code>GitHub</code> ä¸Šå¾ˆç«çš„é¡¹ç›®ï¼Œ<strong>Run Third-Party Scripts From A Web Worker</strong></p><p><img src="/webworker-app/assets/partytown.0f75f942.png" alt=""></p><p>Partytown çš„ä¸€äº›ç›®æ ‡åŒ…æ‹¬ï¼š</p><ol><li>é‡Šæ”¾ä¸»çº¿ç¨‹èµ„æºä»¥ä»…ç”¨äºä¸»è¦ Web åº”ç”¨ç¨‹åºæ‰§è¡Œã€‚</li><li>æ²™ç›’ç¬¬ä¸‰æ–¹è„šæœ¬å¹¶å…è®¸æˆ–æ‹’ç»å…¶è®¿é—®ä¸»çº¿ç¨‹ APIã€‚</li><li>åœ¨ Web Worker çº¿ç¨‹ä¸­éš”ç¦»é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ã€‚</li><li>é€šè¿‡å°† DOM setter/getter æ‰¹å¤„ç†åˆ°ç»„æ›´æ–°ä¸­æ¥å‡å°‘æ¥è‡ªç¬¬ä¸‰æ–¹è„šæœ¬çš„å¸ƒå±€æŠ–åŠ¨ã€‚</li><li>é™åˆ¶ç¬¬ä¸‰æ–¹è„šæœ¬å¯¹ä¸»çº¿ç¨‹çš„è®¿é—®ã€‚</li><li>å…è®¸ç¬¬ä¸‰æ–¹è„šæœ¬å®Œå…¨æŒ‰ç…§å®ƒä»¬çš„ç¼–ç æ–¹å¼è¿è¡Œï¼Œæ— éœ€ä»»ä½•æ›´æ”¹ã€‚</li><li>åŒæ­¥ è¯»å–å’Œå†™å…¥ä¸»çº¿ç¨‹ DOM æ“ä½œ ï¼Œå…è®¸ä» web worker è¿è¡Œçš„è„šæœ¬æŒ‰é¢„æœŸæ‰§è¡Œã€‚</li></ol><p>è€Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨ <code>web worker</code> æ—¶è¦æ€è€ƒçš„é—®é¢˜ã€‚</p><h2 id="æŠ€æœ¯å±•æœ›" tabindex="-1">æŠ€æœ¯å±•æœ› <a class="header-anchor" href="#æŠ€æœ¯å±•æœ›" aria-hidden="true">#</a></h2><ol><li>å¤šçº¿ç¨‹å¤„ç†åœ¨çº¿æ–‡æ¡£ã€éŸ³è§†é¢‘å·¥å…·</li><li><code>webassembly</code> åŸç”Ÿçš„æ•°æ®æ“ä½œ</li></ol></div></div><footer class="page-footer" data-v-30e7de44 data-v-504b1bfc><div class="edit" data-v-504b1bfc><div class="edit-link" data-v-504b1bfc data-v-40c300d5><!----></div></div><div class="updated" data-v-504b1bfc><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"f57c00b5\"}")</script>
    <script type="module" async src="/webworker-app/assets/app.b663589b.js"></script>
    
  </body>
</html>