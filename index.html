<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端web多线程应用开发 | 前端web多线程应用开发</title>
    <meta name="description" content="迅雷云前端分享-李兴广.">
    <link rel="stylesheet" href="/webworker-app/assets/style.c62ae67b.css">
    <link rel="modulepreload" href="/webworker-app/assets/app.b663589b.js">
    <link rel="modulepreload" href="/webworker-app/assets/index.md.f57c00b5.lean.js">
    
    <meta name="twitter:title" content="前端web多线程应用开发 | 前端web多线程应用开发">
  <meta property="og:title" content="前端web多线程应用开发 | 前端web多线程应用开发">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-2ba227d5><div class="sidebar-button" data-v-2ba227d5><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/webworker-app/" aria-label="前端web多线程应用开发, back to home" data-v-2ba227d5 data-v-b3da5816><!----> 前端web多线程应用开发</a><div class="flex-grow" data-v-2ba227d5></div><div class="nav" data-v-2ba227d5><!----></div><!--[--><!--]--></header><aside class="sidebar" data-v-79af364c><!----><!--[--><!--]--><ul class="sidebar-links" data-v-79af364c><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#前言">前言</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#一、明确-javascript-是单线程">一、明确 JavaScript 是单线程</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#二、新曙光：web-worker">二、新曙光：Web Worker</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#三、基本流程">三、基本流程</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-主线程">1. 主线程</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-子线程">2. 子线程</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#三、场景具现">三、场景具现</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-文件gcid计算">1. 文件gcid计算</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-mpeg-ts-webplayer-播放器">2. mpeg-ts-webplayer 播放器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_3-webassembly-播放器">3. webassembly 播放器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-mqtt通信">4. MQTT通信</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_5-bt文件解析器">5. BT文件解析器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_6-indexdb缓存方式">6. IndexDb缓存方式</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_7-lottie动画实现">7. Lottie动画实现</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_8-pdf在线预览方案">8. PDF在线预览方案</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#四、架构策略">四、架构策略</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-函数式创建并运行-web-worker">1. 函数式创建并运行 web worker</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-vite-ts-worker-一个快速构建-worker-模块的模板">2. vite-ts-worker 一个快速构建 worker 模块的模板</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_3-谷歌的-comlink">3. 谷歌的 Comlink</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-partytown-执行第三方脚本方案">4. Partytown 执行第三方脚本方案</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#技术展望">技术展望</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-30e7de44><div class="container" data-v-30e7de44><!--[--><!--]--><div style="position:relative;" class="content" data-v-30e7de44><div><h1 id="前端web多线程应用开发" tabindex="-1">前端web多线程应用开发 <a class="header-anchor" href="#前端web多线程应用开发" aria-hidden="true">#</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-hidden="true">#</a></h2><p>两年前我曾在小组内分享过 <a href="https://gitee.com/sternelee/example-worker" target="_blank" rel="noopener noreferrer">web worker实践</a>，而这一年多在做云盘业务时有很多的场景都运用了这一技术，所以在这里继续分享下这些有趣的开发经验。</p><h2 id="一、明确-javascript-是单线程" tabindex="-1">一、明确 <code>JavaScript</code> 是单线程 <a class="header-anchor" href="#一、明确-javascript-是单线程" aria-hidden="true">#</a></h2><blockquote><p>✅ <code>JavaScript</code> 语言的一大特点就是单线程，也就是说，同一个时间只能做一件事。</p></blockquote><p>听起来有些匪夷所思，为什么不设计成多线程提高效率呢？我们可以假设一种场景： 假定 <code>JavaScript</code> 同时有两个线程，一个线程在某个 <code>DOM</code> 节点上添加内容，另一个线程删除了这个节点，这时浏览器应该以哪个线程为准？</p><blockquote><p>✅ 作为浏览器脚本语言，<code>JavaScript</code> 的主要用途是与用户互动，以及操作 DOM。</p></blockquote><p>这决定了它只能是单线程，否则会带来很复杂的同步问题。为了避免复杂性，从一诞生，<code>JavaScript</code> 就是单线程，这已经成了这门语言的核心特征，估计短期内很难改变。</p><h2 id="二、新曙光：web-worker" tabindex="-1">二、新曙光：Web Worker <a class="header-anchor" href="#二、新曙光：web-worker" aria-hidden="true">#</a></h2><p>单线程始终是一个痛点，为了利用多核 <strong>CPU</strong> 的计算能力，<code>HTML5</code> 提出 Web Worker 标准，允许 <code>JavaScript</code> 脚本创建多个线程。但是子线程完全受主线程控制，且不得操作 <code>DOM</code>。</p><blockquote><p>💻 所以，这个新标准并没有改变 <code>JavaScript</code> 单线程的本质。</p></blockquote><p><code>Web Workers</code> 是现代浏览器提供的一个 <code>JavaScript</code> 多线程解决方案，我们可以找到很多使用场景：</p><ol><li>我们可以用 <code>Web Worker</code> 做一些大计算量的操作；</li><li>可以实现轮询，改变某些状态；</li><li>页头消息状态更新，比如页头的消息个数通知；</li><li>高频用户交互，拼写检查，譬如：根据用户的输入习惯、历史记录以及缓存等信息来协助用户完成输入的纠错、校正功能等</li><li>加密：加密有时候会非常地耗时，特别是如果当你需要经常加密很多数据的时候（比如，发往服务器前加密数据）。</li><li>预取数据：为了优化网站或者网络应用及提升数据加载时间，你可以使用 <strong>Workers</strong> 来提前加载部分数据以备不时之需。</li></ol><blockquote><p>💻 通过使用<code>Web Workers</code>，Web应用程序可以在独立于主线程的后台线程中，运行一个脚本操作。这样做的好处是可以在独立线程中执行费时的处理任务，从而允许主线程（通常是<strong>UI</strong>线程）不会因此被阻塞/放慢。</p></blockquote><p>加密是一个使用 <code>Web Worker</code> 的绝佳场景，因为它并不需要访问 DOM 或者利用其它魔法，它只是纯粹使用算法进行计算而已。</p><blockquote><p>🔥 一旦在 <code>Worker</code> 进行计算，它对于用户来说是无缝地且不会影响到用户体验。</p></blockquote><h2 id="三、基本流程" tabindex="-1">三、基本流程 <a class="header-anchor" href="#三、基本流程" aria-hidden="true">#</a></h2><h3 id="_1-主线程" tabindex="-1">1. 主线程 <a class="header-anchor" href="#_1-主线程" aria-hidden="true">#</a></h3><p><img src="/webworker-app/assets/webworker-main.75914da5.png" alt=""></p><h3 id="_2-子线程" tabindex="-1">2. 子线程 <a class="header-anchor" href="#_2-子线程" aria-hidden="true">#</a></h3><p><img src="/webworker-app/assets/webworker-worker.26dc64b7.png" alt=""></p><h2 id="三、场景具现" tabindex="-1">三、场景具现 <a class="header-anchor" href="#三、场景具现" aria-hidden="true">#</a></h2><h3 id="_1-文件gcid计算" tabindex="-1">1. 文件gcid计算 <a class="header-anchor" href="#_1-文件gcid计算" aria-hidden="true">#</a></h3><blockquote><p>在做web端云盘大文件上传时，我们需要判断该文件是否支持传（服务存有相同的文件），我们需要对文件计算<code>gcid</code>值, 但crypto.js计算文件sha1值会卡线程，阻塞用户交互,并且是个耗时的过程</p></blockquote><p>在此创建了 <a href="https://gitlab.xunlei.cn/xl9_web/gcid-worker" target="_blank" rel="noopener noreferrer">gcid-worker</a> 模块，用于在 <code>web worker</code> 子线程环境下分片计算 <code>SHA1</code> 值并最终生成唯一字符串</p><div class="language-typescript"><pre><code><span class="token keyword">import</span> GcidWorker <span class="token keyword">from</span> <span class="token string">&#39;@xunlei/gcid-worker&#39;</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GcidWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;file&#39;</span><span class="token punctuation">)</span>

file<span class="token operator">?.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;change&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> blockSize <span class="token operator">=</span> worker<span class="token punctuation">.</span><span class="token function">getChunkSize</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token constant">CHUNK_MIN_SIZE</span> <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>
  <span class="token keyword">const</span> <span class="token constant">CHUNK_SIZE</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token constant">CHUNK_MIN_SIZE</span> <span class="token operator">/</span> blockSize<span class="token punctuation">)</span> <span class="token operator">*</span> blockSize
  <span class="token keyword">const</span> <span class="token constant">CHUNK_LEN</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token constant">CHUNK_SIZE</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> reverseIndex <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">await</span> worker<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> worker<span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span>result <span class="token keyword">as</span> ArrayBuffer<span class="token punctuation">)</span>
    reverseIndex <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reverseIndex <span class="token operator">&gt;=</span> <span class="token constant">CHUNK_LEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> worker<span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">seek</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">seek</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">seek</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token constant">CHUNK_SIZE</span> <span class="token operator">*</span> reverseIndex
    <span class="token keyword">const</span> end <span class="token operator">=</span> <span class="token punctuation">(</span>reverseIndex <span class="token operator">&gt;=</span> <span class="token constant">CHUNK_LEN</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> file<span class="token punctuation">.</span>size <span class="token operator">:</span> <span class="token constant">CHUNK_SIZE</span> <span class="token operator">*</span> <span class="token punctuation">(</span>reverseIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> slice <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
    reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>slice<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_2-mpeg-ts-webplayer-播放器" tabindex="-1">2. <code>mpeg-ts-webplayer</code> 播放器 <a class="header-anchor" href="#_2-mpeg-ts-webplayer-播放器" aria-hidden="true">#</a></h3><blockquote><p>在做web云盘的文件消费时，视频在线播放是占最大比重的使用场景; 而目前迅雷云盘存放的转码视频为 <code>h265</code> 的 <code>mpeg-ts</code> 格式，浏览器原生不支持</p></blockquote><p>在需求评估下，我探索了一些开源的<code>mpeg-ts</code>播放器方案,并结合现下的云盘场景，开发了一套 <code>M3U8</code> 播放器方案: <a href="https://gitlab.xunlei.cn/xl9_web/mpeg-ts-webplayer/tree/develop" target="_blank" rel="noopener noreferrer">mpeg-ts-webplayer</a></p><p>在三大功能场景下采用 <code>web worker</code> 技术</p><ol><li>HTTP 请求封装器 <a href="https://gitlab.xunlei.cn/xl9_web/mpeg-ts-webplayer/blob/develop/src/workers/httpWorker.ts" target="_blank" rel="noopener noreferrer">httpWorker.ts</a>: 在独立的线程下处理分片数据请求,控制缓存数据量</li><li>Demux 解复用器 <a href="https://gitlab.xunlei.cn/xl9_web/mpeg-ts-webplayer/blob/develop/src/workers/demuxWorker.ts" target="_blank" rel="noopener noreferrer">demuxWorker.ts</a>: 在 <code>web worker</code> 线程下处理 <code>mpeg-ts</code> 数据流，将其解封装生成音频流和视频流(<code>h265</code>源数据)</li><li>Decode 视频解析 <a href="https://gitlab.xunlei.cn/xl9_web/mpeg-ts-webplayer/blob/develop/src/workers/decodeWorker.ts" target="_blank" rel="noopener noreferrer">decodeWorker.ts</a>: 利用 <code>ffmpeg</code> 工具生成 <code>webassembly</code> 解码器，将 <code>h265</code> 视频解码成 <code>YUV</code> 视频画面, 并最终回传给主线程，采用 <code>yuv-canvas</code> 进绘制播放</li></ol><p>该方案配合迅雷云盘转码的方案，使用有序的 <code>m3u8</code> 数据表来进行连惯的在线 mpeg-ts（h265)播放，在这里有效的利用 <code>web worker</code> 的特殊的场景能力来请求网络请求、webassembly加载解析、复杂繁重计算等不替代的功能</p><video controls="" preload style="width:100%;"><source src="http://static.leeapps.cn/webworker-mpeg-player.mp4" type="video/mp4"></video><h3 id="_3-webassembly-播放器" tabindex="-1">3. <code>webassembly</code> 播放器 <a class="header-anchor" href="#_3-webassembly-播放器" aria-hidden="true">#</a></h3><blockquote><p>在适配小米手机浏览器集成迅雷云盘之后，我们需要在H5端实现几乎所有格式的视频播放, 相当于要在浏览器端实现 Web 版迅雷播放器</p></blockquote><p><a href="https://gitlab.xunlei.cn/xl9_web/h5player-pan.xunlei.com" target="_blank" rel="noopener noreferrer">h5player-pan.xunlei.com</a> 项目同时支持 原生视频video标签、小米浏览器 m3u8 和 <code>webassembly</code> 播放模式, 体验 <code>webassembly</code> 高性能播放在访问 <a href="https://pan.xunlei.com/xapp/play/" target="_blank" rel="noopener noreferrer">https://pan.xunlei.com/xapp/play/</a> , 只需设置 <code>?playType=1</code> 并提供可访问的 <code>https</code> 的资源链接即可播放</p><video controls="" preload style="width:100%;"><source src="http://static.leeapps.cn/webworker-aplayer.mp4" type="video/mp4"></video><p>🌟 Tip: 该方案采用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/SharedWorker" target="_blank" rel="noopener noreferrer"><code>Shared Worker</code></a> 需要注意几点</p><ol><li>这些页面和资源请求必须是同源的</li><li>页面通过配置 nginx 配置同源策略，如下显示</li></ol><div class="language-yml"><pre><code>add_header Cross<span class="token punctuation">-</span>Origin<span class="token punctuation">-</span>Opener<span class="token punctuation">-</span>Policy &#39;same<span class="token punctuation">-</span>origin&#39;;
add_header Cross<span class="token punctuation">-</span>Origin<span class="token punctuation">-</span>Embedder<span class="token punctuation">-</span>Policy &#39;require<span class="token punctuation">-</span>corp&#39;;
</code></pre></div><ol start="3"><li>注意内存回收和浏览器兼容性</li></ol><h3 id="_4-mqtt通信" tabindex="-1">4. MQTT通信 <a class="header-anchor" href="#_4-mqtt通信" aria-hidden="true">#</a></h3><blockquote><p>在开发NAS云盘H5时，任务的更新都依赖定时更新任务接口，在多端操作时会响应不及时的情况</p></blockquote><p>在此场景下，结合帐号现有的<code>xbase mqtt</code>流程，创建了 <a href="https://gitlab.xunlei.cn/xl_public_service/mqtt-worker" target="_blank" rel="noopener noreferrer"><code>mqtt-worker</code></a> 模块，与 <code>xbase</code> 帐号解耦，并采用 <code>worker</code> 线程来处理消息。</p><div class="language-typescript"><pre><code><span class="token keyword">import</span> SyncClient <span class="token keyword">from</span> <span class="token string">&#39;@xunlei/mqtt-worker&#39;</span>

<span class="token keyword">const</span> projectID <span class="token operator">=</span> <span class="token string">&#39;2rvk4e3gkdnl7u1kl0k&#39;</span> <span class="token comment">//参考：https://xbase.cloud/docs/%E5%AE%9E%E6%97%B6%E9%80%9A%E4%BF%A1%E5%BC%95%E6%93%8E/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8</span>
<span class="token comment">// 登陆态</span>
<span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string-property property">&quot;token_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;Bearer&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;access_token&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;refresh_token&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;expires_in&quot;</span><span class="token operator">:</span><span class="token number">3600</span><span class="token punctuation">,</span><span class="token string-property property">&quot;sub&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;user_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;expires_at&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> user_id <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
<span class="token keyword">const</span> deviceID <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
<span class="token keyword">const</span> syncClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  projectID<span class="token punctuation">,</span>
  token<span class="token punctuation">,</span>
  user_id<span class="token punctuation">,</span>
  deviceID<span class="token punctuation">,</span>
  <span class="token comment">// client_version: &#39;1.0.0&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 监听云盘文件变更的主题</span>
<span class="token keyword">const</span> subject <span class="token operator">=</span> <span class="token string">&#39;/user/me/drive/tasks&#39;</span> <span class="token comment">//  用户信息变更&#39;/user/me/info&#39;</span>
syncClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connect&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 监听连接成功</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;result connect&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
  <span class="token comment">// 发送监听主题</span>
  syncClient<span class="token punctuation">.</span><span class="token function">startReceiver</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
syncClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;topic&#39;</span><span class="token punctuation">,</span> data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;topics&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
syncClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 接收主题事件</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
syncClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;其他消息&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 连接</span>
syncClient<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 发送消息</span>
syncClient<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> subject<span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 关闭</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> syncClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">6000</span><span class="token punctuation">)</span>
</code></pre></div><p>注意：<code>MQTT</code>方案需要考虑多标签情况下登陆态互踢的情况</p><h3 id="_5-bt文件解析器" tabindex="-1">5. BT文件解析器 <a class="header-anchor" href="#_5-bt文件解析器" aria-hidden="true">#</a></h3><p><a href="https://gitlab.xunlei.cn/xl9_web/bencode-worker" target="_blank" rel="noopener noreferrer">bencode-worker</a> 使用 <code>bencode</code> + <code>web worker</code> 将bt文件转成磁力链接；这是 <a href="https://pan.xunlei.com/yc/" target="_blank" rel="noopener noreferrer">NAS云盘H5</a>使用的方案</p><div class="language-typescript"><pre><code><span class="token keyword">import</span> btdecode <span class="token keyword">from</span> <span class="token string">&#39;@xunlei/bencode-worker&#39;</span>

<span class="token keyword">const</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;file&#39;</span><span class="token punctuation">)</span>
file<span class="token operator">?.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;change&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>evt<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> file <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">btdecode</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_6-indexdb缓存方式" tabindex="-1">6. IndexDb缓存方式 <a class="header-anchor" href="#_6-indexdb缓存方式" aria-hidden="true">#</a></h3><blockquote><p>🌈 你不能直接在 worker 线程中操纵 DOM 元素；或使用window 对象中的某些方法和属性。大部分 window 对象的方法和属性是可以使用的，包括 WebSockets 和 IndexedDB。 - 摘自 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API" target="_blank" rel="noopener noreferrer">Web_Workers_API</a></p></blockquote><p><a href="https://gitee.com/sternelee/vite-translator-worker" target="_blank" rel="noopener noreferrer">translator-worker</a> 前端实现页面翻译, 这是我从 <a href="https://github.com/FilipePS/Traduzir-paginas-web" target="_blank" rel="noopener noreferrer">Traduzir-paginas-web</a> 插件提取而来, 并更改为 <code>worker</code> 线程版本，使用也极其方便</p><div class="language-typescript"><pre><code><span class="token keyword">import</span> translator <span class="token keyword">from</span> <span class="token string">&#39;@sternelee/translator-worker&#39;</span>

window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 翻译全文</span>
  translator<span class="token punctuation">.</span><span class="token function">translatePage</span><span class="token punctuation">(</span><span class="token string">&quot;zh&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 翻译文本</span>
  <span class="token keyword">const</span> txt <span class="token operator">=</span> <span class="token keyword">await</span> translator<span class="token punctuation">.</span><span class="token function">translateText</span><span class="token punctuation">(</span><span class="token string">&quot;google&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;zh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;I Love Code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 恢复</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    translator<span class="token punctuation">.</span><span class="token function">restorePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里有实际使用的线上页面 <a href="https://weekly.leeapps.cn/" target="_blank" rel="noopener noreferrer">https://weekly.leeapps.cn/</a></p><video controls="" preload style="width:100%;"><source src="http://static.leeapps.cn/webworker-indexdb.mp4" type="video/mp4"></video><h3 id="_7-lottie动画实现" tabindex="-1">7. Lottie动画实现 <a class="header-anchor" href="#_7-lottie动画实现" aria-hidden="true">#</a></h3><p><a href="https://gitee.com/sternelee/rlottie-worker" target="_blank" rel="noopener noreferrer">rlottie-worker</a> 这是我使用 <code>rlottie</code> + <code>pako</code> + <code>webworker</code> 在前端实现 <code>lottie</code> 的动画效果, 是从<code>telegram</code> 官网动画的效果提取出来的</p><p>使用也非常方便</p><div class="language-typescript"><pre><code><span class="token keyword">import</span> RLottie <span class="token keyword">from</span> <span class="token string">&#39;@sternelee/rlottie&#39;</span>

document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">&#39;.rlottie_image&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>imgEl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  RLottie<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>imgEl<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string-property property">&quot;maxDeviceRatio&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string-property property">&quot;cachingModulo&quot;</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><iframe style="width:100%;" frameborder="0" scrolling="0" height="600px" src="http://leeapps.cn:4002/">
</iframe><h3 id="_8-pdf在线预览方案" tabindex="-1">8. PDF在线预览方案 <a class="header-anchor" href="#_8-pdf在线预览方案" aria-hidden="true">#</a></h3><p>当前web云盘的pdf在线预览采用了 <a href="https://mozilla.github.io/pdf.js/" target="_blank" rel="noopener noreferrer">PDF.js</a>, 同样依赖 <code>web worker</code> 来实现pdf文件的解析</p><h2 id="四、架构策略" tabindex="-1">四、架构策略 <a class="header-anchor" href="#四、架构策略" aria-hidden="true">#</a></h2><p>创建 <code>web worker</code> 的方式很多, 如外联引入js, <code>Blob</code> 内联, 并采用<code>promise</code>模式</p><h3 id="_1-函数式创建并运行-web-worker" tabindex="-1">1. 函数式创建并运行 <code>web worker</code> <a class="header-anchor" href="#_1-函数式创建并运行-web-worker" aria-hidden="true">#</a></h3><p><a href="https://gitlab.xunlei.cn/xl9_web/universal-native-api/blob/master/src/lib/utils.ts#L281" target="_blank" rel="noopener noreferrer">promiseWorkerFun</a> 这是一个经典的方法,并集成到 <code>universal-native-api</code> 中</p><div class="language-typescript"><pre><code><span class="token comment">/**
 * @description 在内联web worker中运行函数
 * @param {Function} func - 函数
 * @param {any[]} message - 函数参数
 * @returns {Promise} - 返回Promise对象执行结果
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">promiseWorkerFun</span><span class="token punctuation">(</span>func<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> <span class="token operator">...</span>message<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">delegate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token punctuation">{</span> func<span class="token punctuation">,</span> message <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">wrapper</span> <span class="token operator">=</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token function">Function</span><span class="token punctuation">(</span><span class="token string">&#39;&quot;use strict&quot;; return (&#39;</span> <span class="token operator">+</span> fn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;)&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">...</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">postMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> functionBody <span class="token operator">=</span> delegate
    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[^{]*{\s*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s*}[^}]*$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>
      <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>functionBody<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;text/javascript&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      worker<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span>onerror <span class="token operator">=</span> worker<span class="token punctuation">.</span>onmessageerror <span class="token operator">=</span> reject<span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> func<span class="token operator">:</span> func<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> worker<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-vite-ts-worker-一个快速构建-worker-模块的模板" tabindex="-1">2. <a href="https://gitlab.xunlei.cn/xl9_web/fe-template/tree/vite-ts-worker" target="_blank" rel="noopener noreferrer">vite-ts-worker</a> 一个快速构建 <code>worker</code> 模块的模板 <a class="header-anchor" href="#_2-vite-ts-worker-一个快速构建-worker-模块的模板" aria-hidden="true">#</a></h3><p>使用 <code>vite</code> 来打包 <code>web worker</code> 功能库 根据需求配置 <code>vite.config.ts</code> 打包生成的文件</p><p>上面介绍到的 <code>gcid-worker</code>, <code>bencode-worker</code>, 以及 <code>translator-worker</code> 都是采用该模板打包</p><p><a href="https://cn.vitejs.dev/guide/assets.html#importing-script-as-a-worker" target="_blank" rel="noopener noreferrer">vite 打包</a> 原生支持了导入脚本作为 Worker 的功能,并做内联模块或字符串形式</p><h3 id="_3-谷歌的-comlink" tabindex="-1">3. 谷歌的 <a href="https://github.com/GoogleChromeLabs/comlink" target="_blank" rel="noopener noreferrer"><code>Comlink</code></a> <a class="header-anchor" href="#_3-谷歌的-comlink" aria-hidden="true">#</a></h3><blockquote><p>让使用webworker超轻松，这是 <code>Comlink</code> 的实现方向</p></blockquote><p><img src="/webworker-app/assets/comlink.8a7c8a30.png" alt=""></p><p><code>Comlink</code> 采用了 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Channel_Messaging_API" target="_blank" rel="noopener noreferrer">Channel Messaging API</a>。 具体解析 -&gt; <a href="https://juejin.cn/post/6968503345031938085" target="_blank" rel="noopener noreferrer">Comlink 的使用 &amp; 源码解析</a></p><blockquote><p>Channel Messaging API 允许两个不同的脚本运行在同一个文档的不同浏览器上下文（比如两个 iframe，或者文档主体和一个 iframe，使用 SharedWorker 的两个文档，或者两个 worker）来直接通讯，在每端使用一个端口（port）通过双向频道（channel）向彼此传递消息。</p></blockquote><h3 id="_4-partytown-执行第三方脚本方案" tabindex="-1">4. <a href="https://partytown.builder.io/" target="_blank" rel="noopener noreferrer"><code>Partytown</code></a> 执行第三方脚本方案 <a class="header-anchor" href="#_4-partytown-执行第三方脚本方案" aria-hidden="true">#</a></h3><p>这是最近 <code>GitHub</code> 上很火的项目，<strong>Run Third-Party Scripts From A Web Worker</strong></p><p><img src="/webworker-app/assets/partytown.0f75f942.png" alt=""></p><p>Partytown 的一些目标包括：</p><ol><li>释放主线程资源以仅用于主要 Web 应用程序执行。</li><li>沙盒第三方脚本并允许或拒绝其访问主线程 API。</li><li>在 Web Worker 线程中隔离长时间运行的任务。</li><li>通过将 DOM setter/getter 批处理到组更新中来减少来自第三方脚本的布局抖动。</li><li>限制第三方脚本对主线程的访问。</li><li>允许第三方脚本完全按照它们的编码方式运行，无需任何更改。</li><li>同步 读取和写入主线程 DOM 操作 ，允许从 web worker 运行的脚本按预期执行。</li></ol><p>而这也是我们在使用 <code>web worker</code> 时要思考的问题。</p><h2 id="技术展望" tabindex="-1">技术展望 <a class="header-anchor" href="#技术展望" aria-hidden="true">#</a></h2><ol><li>多线程处理在线文档、音视频工具</li><li><code>webassembly</code> 原生的数据操作</li></ol></div></div><footer class="page-footer" data-v-30e7de44 data-v-504b1bfc><div class="edit" data-v-504b1bfc><div class="edit-link" data-v-504b1bfc data-v-40c300d5><!----></div></div><div class="updated" data-v-504b1bfc><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"f57c00b5\"}")</script>
    <script type="module" async src="/webworker-app/assets/app.b663589b.js"></script>
    
  </body>
</html>